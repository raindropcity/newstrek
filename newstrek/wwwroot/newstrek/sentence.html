<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>NewsTrek</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="../css/sign-up.css">
    <link rel="stylesheet" href="../css/sign-in.css">
    <link rel="stylesheet" href="../css/sentence.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
        integrity="sha512-1ycn6IcaQQ40/MKBW2W4Rhis/DbILU74C1vSrLJxCq57o941Ym01SwNsOMqvEBFlcgUa6xLiPY/NS5R+E6ztJQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:ital@1&display=swap" rel="stylesheet">
</head>

<body class="main-content">
    <section class="section sec5 contact" id="contact">
        <div class="contact-container">
            <div class="main-title">
                <h2>Make a <span>Sentence</span></h2>
            </div>
            <div class="sign-in-content">
                <form class="sign-in-form">
                    <div class="left-sign-in">
                        <div class="input-control">
                            <input type="text" required placeholder="Vocabulary 1" name="word-1" class="word"
                                id="word-1">
                        </div>
                        <div class="input-control">
                            <input type="text" required placeholder="Vocabulary 2" name="word-2" class="word"
                                id="word-2">
                        </div>
                        <div class="input-control">
                            <input type="text" required placeholder="Vocabulary 3" name="word-3" class="word"
                                id="word-3">
                        </div>
                    </div>
                    <div class="right-sign-in" id="sentence-btn-area">
                        <div class="sign-in-btn-div">
                            <button type="submit" class="sign-in-submit-btn">
                                <span>Submit</span>
                            </button>
                        </div>
                        <div class="clear-btn-div">
                            <button class="clear-btn">
                                <span>Clear</span>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
            <div class="sentence-area">
                <h3>A sentence generated by OpenAI :</h3>
                <div class="sentence">

                </div>
            </div>
        </div>
    </section>

    <!-- 右側fixed button -->
    <div class="controlls">
        <a href="/newstrek/home.html" class="control control-1 active-btn" data-id="home" title="Home">
            <i class="fas fa-home"></i>
        </a>
        <a href="/newstrek/category.html" class="control control-4 active-btn" data-id="blogs" title="News">
            <i class="far fa-newspaper"></i>
        </a>
        <a href="/newstrek/sentence.html" class="control control-3 active-btn" data-id="portfolio"
            title="Make a Sentence">
            <i class="far fa-comment-dots"></i>
        </a>
        <a href="/newstrek/profile.html" class="control control-2 active-btn" data-id="about" title="Your Profile">
            <i class="fas fa-user"></i>
        </a>
        <a href="/newstrek/sign-in.html" class="control control-5 active-btn" data-id="contact" title="LogOut">
            <i class="fas fa-sign-out-alt"></i>
        </a>
    </div>

    <!-- 引用JS -->
    <script type="text/javascript">
        document.addEventListener('DOMContentLoaded', () => {
            const submitBtn = document.querySelector(".sign-in-submit-btn")
            const logOutBtn = document.querySelector(".controlls a[title=\"LogOut\"]")
            const clearBtn = document.querySelector(".clear-btn")

            const word_1 = document.querySelector("#word-1")
            const word_2 = document.querySelector("#word-2")
            const word_3 = document.querySelector("#word-3")

            logOutBtn.addEventListener('click', () => {
                if (window.localStorage.getItem("JWT_token")) {
                    window.localStorage.removeItem("JWT_token")
                }
            })

            clearBtn.addEventListener('click', (event) => {
                event.preventDefault()
                word_1.value = ""
                word_2.value = ""
                word_3.value = ""
            })

            submitBtn.addEventListener('click', (event) => {
                event.preventDefault()

                const token = window.localStorage.getItem('JWT_token')

                const userInputedWords = document.querySelectorAll(".word")
                const inputData = []

                if (word_1.value.trim() != '' || word_2.value.trim() != '' || word_3.value.trim() != '') {
                    makeSentence()
                } else {
                    alert("Please input one vocabulary at least")
                }

                async function makeSentence() {
                    const fetchPromises = []

                    for (const word of userInputedWords) {
                        if (word.value) {
                            const fetchPromise = fetch(`/Dictionary/look-up-words?word=${word.value}`, { headers: { Authorization: `Bearer ${token}` } })
                                .then(response => {
                                    if (response.status === 401) {
                                        alert("Your sign in status has expired. Please sign in again.")
                                        window.location.assign("/newstrek/sign-in.html")
                                    }
                                    else if (response.status === 403) {
                                        alert("Your identity authentication token is not valid. Please contact the developer, thanks!")
                                        window.location.assign("/newstrek/sign-in.html")
                                    }
                                    return response
                                })
                                .then(response => {
                                    if (response.status === 200) {
                                        return response.json()
                                    } else {
                                        throw new Error("Request failed")
                                    }
                                })
                                .catch(error => {
                                    console.error('Error in fetch:', error)
                                    return null // Return null for failed requests
                                })

                            fetchPromises.push(fetchPromise)
                        }
                        else {
                            fetchPromises.push(word.value)
                        }
                    }

                    const results = await Promise.all(fetchPromises)
                    console.log(results)
                    let nextStepOrNot = true

                    results.forEach((data, index) => {
                        if (data && data.length > 0 && data[0].meta) {
                            inputData.push(userInputedWords[index].value)
                        } else if (data) {
                            userInputedWords[index].style.border = 'red 2px solid'
                            userInputedWords[index].value = `${userInputedWords[index].value} (check your spelling)`
                            nextStepOrNot = false
                        }
                    })

                    console.log(inputData)
                    console.log(nextStepOrNot)

                    if (nextStepOrNot) {
                        console.log("ready to fire request to OpenAI")

                        fetch("/api/OpenAi/CompleteSentence", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                                "Authorization": `Bearer ${token}`
                            },
                            body: JSON.stringify(inputData)
                        })
                            .then(response => {
                                if (response.status === 401) {
                                    alert("Your sign in status has expired. Please sign in again.")
                                    window.location.assign("/newstrek/sign-in.html")
                                }
                                else if (response.status === 403) {
                                    alert("Your identity authentication token is not valid. Please contact the developer, thanks!")
                                    window.location.assign("/newstrek/sign-in.html")
                                }
                                return response.json()
                            })
                            .then(data => {
                                console.log(data)
                                const sentence = document.querySelector(".sentence")
                                sentence.innerHTML = `
                                        <p><i class="fas fa-angle-double-right"></i>${data.result}</p>
                                    `
                            })
                            .catch(error => {
                                console.log(error)
                            })
                    }
                    else {
                        console.log("stop firing request to OpenAI")
                        const inputArea = document.querySelector(".left-sign-in")
                        inputArea.addEventListener('focusin', focusHandler)
                    }
                }
            })

            function focusHandler(e) {
                console.log("focusHandler fired")
                console.log(e.target)
                e.target.style.border = 'none'
                e.target.value = `${e.target.value.replace(" (check your spelling)", "")}`
                e.target.parentElement.parentElement.removeEventListener('focusin', focusHandler)
            }
        })
    </script>
</body>

</html>